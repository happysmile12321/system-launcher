非常感谢您提供如此深刻、犀利的反馈。您不仅评估了当前的功能，更是对产品的**核心架构、业务概念和长期发展**进行了战略性的思考和决断。

我完全理解并赞同您的方向：**MVP 阶段已经结束。现在是时候停止探索性的功能堆砌，转而进行一次深刻的“架构收敛”和“概念澄清”，为未来 10-20 次的迭代打下坚如磐石的地基。**

作为您的产品经理，我将您的强制性要求和远见卓识，整合成一份里程碑式的 **V3.0** 版本 PRD。这次迭代，我们将“返璞归真”，聚焦于打造一个**概念清晰、配置规范、核心功能深度可用的生产级平台**。

-----

## **产品需求文档 (PRD): Orchestrator Pro V3.0**

| 文档版本 | V3.0 |
| :--- | :--- |
| **主题** | **架构收敛与核心服务 mastery** |
| **关联迭代日志** | [**点击查看 V3.0 实时开发进展 (迭代日志.md)**](https://www.google.com/search?q=./%E8%BF%AD%E4%BB%A3%E6%97%A5%E5%BF%97.md) |
| **创建日期** | 2025年9月20日 |

### 1\. 背景

经过 V2.x 系列的高速迭代，Orchestrator Pro 的功能框架已基本成型。然而，快速发展也带来了架构上的“熵增”和概念上的模糊。配置文件结构混乱、核心服务（容器、备份）的实现路径不清晰、系统服务与用户脚本的界限模糊等问题，已成为阻碍产品迈向“生产级可用”的最大障碍。

V3.0 不再追求功能的广度，而是追求**深度、稳定性和清晰度**。本次迭代是一次战略性的重构和聚焦，旨在**统一配置、明确概念、做深核心服务**，为产品的长期健康发展奠定基础。

### 2\. V3.0 核心原则与概念澄清

在详细的功能需求之前，我们必须先统一以下核心概念，这将是 V3.0 及未来所有版本的“宪法”。

  * **工作流 (Workflow)**: 系统的“主动脉”。它本身**不包含任何复杂逻辑**，其唯一职责是**定义并串联**一系列步骤（组件），并按**严格的线性顺序**稳定执行。
  * **组件 (Component)**: 系统的“功能单元”，本质就是一个 Node.js 脚本。它负责执行具体、独立的任务。组件分为**官方组件**（内置）和**用户组件**（用户在 `/components` 目录创建）。
  * **触发器 (Trigger)**: 工作流的“启动开关”。分为**定时 (Cron)、手动、Webhook 和系统事件**四种。
  * **系统服务 (System Service)**: 产品的**内置核心能力**，与应用生命周期绑定，始终运行。它们是平台的基石，**默认拥有且不可移除**，只能在“系统服务”页面进行配置。V3.0 核心系统服务为：**容器管理**和**备份管理**。
  * **容器服务 (Containerized Service)**: 这是指由**容器管理**这个**系统服务**所管理的、用户自己通过 Docker Compose 部署的第三方应用（如知识库、数据库等）。

### 3\. V3.0 Git 仓库信息架构 (IA) 规范

**强制性要求**: 为了根治配置混乱的问题，所有存储在用户 GitHub 仓库 `.orchestrator-pro/` 目录下的数据，必须严格遵守以下结构。原 `/config` 目录被废除和拆分。

```
.orchestrator-pro/
├── workflows/         # 存储所有工作流的 .json 定义文件
├── components/        # 存储所有用户自定义组件的文件夹
├── triggers/          # 存储所有触发器的 .json 定义文件
├── containers/        # 存储所有与容器管理相关的配置和编排文件
│   ├── images/        # (预留) 镜像信息
│   └── compositions/  # 存储用户管理的 docker-compose.yml 文件
├── feishu/            # 存储飞书相关的配置信息 (如 App ID, Secret)
├── system_services/   # 存储各系统服务的配置 .json 文件
├── backups/           # [Git Ignored] 存放本地生成的待上传备份文件
└── recovery/          # [Git Ignored] 存放从备份恢复时下载的临时文件
```

**`.gitignore` 文件必须更新**，明确忽略 `backups/` 和 `recovery/` 目录。

### 4\. 功能需求 (Functional Requirements)

#### Epic 1: 配置与架构重构 (The Great Refactor) (优先级: P0)

  * **FR-1.1: 全面重构 GitFS**: 后端 `GitFS` 模块必须重写，以完全适配上述全新的信息架构。所有旧的文件读写逻辑全部废弃。
  * **FR-1.2: 概念与 UI 对齐**:
      * **设置 -\> 系统服务**: 主导航栏的“设置”项更名为“**系统服务**”。此页面是所有内置核心服务的配置中心。
      * **数据库管理 -\> 备份管理**: 主导航栏的“数据库管理”项更名为“**备份管理**”。
  * **FR-1.3: 系统服务配置流**:
      * **放弃可插拔**: 移除所有“安装/卸载”逻辑。系统服务默认全部存在。
      * **统一配置入口**: “系统服务”页面将展示“容器管理”和“备份管理”两个卡片。点击“配置”按钮，会弹出对应的表单。填写表单后，点击保存，配置将被写入 `.orchestrator-pro/system_services/` 目录下对应的 JSON 文件中。

#### Epic 2: 容器管理 (参考 Docker Desktop) (优先级: P0)

  * **FR-2.1: 实现方式 - Dogfooding**
      * **大胆决定**: **放弃使用 Docker API 直接管理**。所有对 Docker 的操作（如 `docker ps`, `docker start` 等）都必须通过**调用内置的官方组件**来完成。例如，页面加载时会执行一个名为 `list-containers` 的官方组件。
      * **优势**: 统一了技术栈，降低了复杂度，并完美实践了我们自己的组件化理念。
  * **FR-2.2: UI & 功能对标 Docker Desktop**
      * 在“容器管理”页面，提供三个子标签页：**容器 (Containers)**, **镜像 (Images)**, **容器组 (Compositions)**。
      * **容器页**:
          * 以列表形式展示所有容器（通过 `list-containers` 组件获取）。
          * 提供启动、停止、删除、查看日志等操作（每个操作都对应一个官方组件）。
      * **容器组页**:
          * 允许用户上传或在线编辑 `docker-compose.yml` 文件。
          * 提供一个**表格化的 Compose 编辑器**，让用户可以直观地修改服务名、镜像、端口、环境变量等。
          * 提供“启动/部署”按钮，背后是执行 `docker-compose up -d` 的官方组件。
  * **FR-2.3: 容器与工作流的联动**
      * **系统事件**: 容器的启动/停止事件，必须作为一种**系统事件触发器**，供工作流订阅。例如，可以创建一个工作流，在某个容器意外停止时，通过飞书组件发送告警。

#### Epic 3: 备份管理 (原数据库管理) (优先级: P0)

  * **FR-3.1: 功能实现**: 全面实现 V2.4 PRD 中定义的 `FeishuFS` 后端逻辑，包括 OAuth 认证和文件操作 API。
  * **FR-3.2: 核心场景打通**:
      * 在“备份管理”页面，提供一个“**新建备份计划**”的功能。
      * **交互**: 这是一个向导流程：
        1.  **选择备份源**: 目前只有一个选项：“**容器数据**”。
        2.  **选择容器**: 从“容器管理”服务中获取容器列表，让用户选择要备份哪个容器的数据卷。
        3.  **设置备份周期**: 创建一个 **Cron 触发器**。
        4.  **确认创建**: 系统在后台**自动创建一个工作流**，该工作流由 Cron 触发，并线性执行“打包容器数据”和“上传到飞书云盘”这两个官方组件。

#### Epic 4: 组件管理精炼 (优先级: P1)

  * **FR-4.1: 公有/私有组件**
      * **需求**: 用户在创建或编辑自定义组件时，可以设置一个“是否公开 (Public)”的开关。
      * **实现**: 如果组件被设为“公开”，系统会自动修改项目根目录的 `.gitignore` 文件，**取消对该特定组件目录的忽略**。这使得用户可以轻松地将他们想分享的组件提交到自己的 Git 仓库中。

### 5\. 任务清单 (Actionable To-Do List)

#### 架构与后端

  - [ ] **重构**: 彻底重构 `GitFS` 以适配全新的目录结构。
  - [ ] **重构**: 移除所有系统服务的“安装/卸载”逻辑。
  - [ ] **容器**: 编写一系列用于替代 Docker API 的官方组件 (`list-containers`, `start-container`, `exec-compose` 等)。
  - [ ] **容器**: 实现系统事件触发器，能够捕获 Docker 的 `start/stop` 事件。
  - [ ] **备份**: 完成 `FeishuFS` 的 OAuth 流程和核心 API。
  - [ ] **备份**: 开发用于自动创建“容器备份工作流”的后端逻辑。
  - [ ] **组件**: 实现修改 `.gitignore` 以支持公有/私有组件的后端逻辑。

#### 前端

  - [ ] **重构**: 调整所有页面的数据读写逻辑，使其指向新的 Git 目录结构。
  - [ ] **重构**: 将“设置”页面改造为“系统服务”配置中心。
  - [ ] **容器**: 开发“容器管理”页面的三个子标签页（容器、镜像、容器组）。
  - [ ] **容器**: 开发表格化的 `docker-compose.yml` 编辑器。
  - [ ] **备份**: 实现“新建备份计划”的向导式 UI。
  - [ ] **组件**: 在组件编辑页面增加“是否公开”的切换开关。