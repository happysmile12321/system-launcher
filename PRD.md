收到，这次的反馈非常清晰、深刻且极具建设性。您已经从一个产品的使用者和设计者，上升到了**架构师**的视角，开始思考更底层的执行模型和模块间的深度协同。

我完全同意您的判断：**组件的体验是整个产品的核心命脉，而系统服务（数据库、容器）的深度集成则是将产品从“玩具”变为“武器”的关键。**

本次迭代，我们将进行一次大胆而必要的“心脏搭桥手术”——彻底简化组件的执行模型，同时全力打通和深化核心服务的功能闭环。

遵照我们的标准流程，这是为您精心制定的 V2.4 版本 PRD。

-----

## **产品需求文档 (PRD): Orchestrator Pro V2.4**

| 文档版本 | V2.4 |
| :--- | :--- |
| **主题** | **架构简化与深度集成** |
| **关联迭代日志** | [**点击查看 V2.4 实时开发进展 (迭代日志.md)**](https://www.google.com/search?q=./%E8%BF%AD%E4%BB%A3%E6%97%A5%E5%BF%97.md) |
| **创建日期** | 2025年9月20日 |

### 1\. 背景

V2.3 版本成功地为平台搭建了功能齐全的 UI 框架。但在实现过程中，我们遇到了几个尖锐的架构性问题：

1.  **组件执行环境过于复杂**: `isolated-vm` 沙箱环境虽然安全，但带来了严重的兼容性问题（如 ES Module 错误）和依赖管理难题，与我们追求“组件就是简单 Node.js 脚本”的初衷相悖。
2.  **工作流设计体验脱节**: 触发器与步骤编排在 UI 上分离，导致工作流的整体感被削弱，编排区域空间不足。
3.  **核心服务仍是“空中楼阁”**: 数据库（飞书）和容器管理虽有 UI，但后端逻辑尚未实现，无法与工作流等核心功能形成联动。

V2.4 的核心使命是：**进行一次果断的架构简化，彻底解决组件执行的痛点；同时，全力投入后端开发，将数据库和容器管理两大服务的功能做深做透，形成功能的闭环。**

### 2\. V2.4 核心目标

  * **目标 1 (简化架构)**: 废除 `isolated-vm` 沙箱，采用更直接、更灵活的子进程模型执行组件，根治兼容性问题。
  * **目标 2 (优化体验)**: 重新设计工作流编辑器 UI，优化编排体验，并为组件的输入输出提供明确的数据绑定。
  * **目标 3 (功能闭环)**: 全面实现 `FeishuFS` 模块及配套 UI，并将其与容器服务的“数据备份”场景深度打通。
  * **目标 4 (AI 赋能)**: （低优先级）引入 LLM 辅助功能，提升用户在特定场景（如 Cron 表达式编写）下的使用体验。

### 3\. 功能需求 (Functional Requirements)

#### Epic 1: 组件执行模型革命 (The Component Execution Revolution) (优先级: P0)

  * **FR-1.1: 废除沙箱，拥抱子进程**

      * **需求**: **彻底移除 `isolated-vm` 运行时**。将组件的执行模型改为使用 Node.js 内置的 `child_process.fork()`。
      * **执行上下文**: fork 出的子进程，其**当前工作目录 (`cwd`) 必须是该组件所在的目录**。这使得组件可以自由管理自己的文件和依赖。
      * **安全提示**: 由于放弃了沙箱，用户组件将拥有与主应用相同的权限。必须在“我的组件”编辑区添加一个显著、永久的**安全警告**：“警告：自定义组件将以完整权限在您的服务器上运行。请仅执行您信任的代码。”

  * **FR-1.2: 统一组件目录结构**

      * **需求**: 简化项目结构，移除 `components/official` 的概念。所有组件（官方内置和用户自定义）统一存放在项目根目录下的 `/components` 文件夹内。`.gitignore` 需配置为忽略此目录下的所有内容，除了官方组件的文件夹。

  * **FR-1.3: 强化组件清单 (`component.json`) 规范**

      * **痛点**: 组件的输入输出不明确，无法与工作流 UI 打通。
      * **需求**: **强制并完善 `component.json` 的规范**。在创建和编辑组件时，UI 必须引导用户填写结构化的输入（`inputs`）和输出（`outputs`）信息。
      * **`inputs` 字段规范**: 数组中的每个对象必须包含 `id`, `label`, `type` (`string`, `number`, `boolean`, `json`, `secret`), `required`, `description`。
      * **`outputs` 字段规范**: 数组中的每个对象必须包含 `id`, `label`, `type`, `description`。

#### Epic 2: 工作流设计器 UX 体验重构 (优先级: P0)

  * **FR-2.1: 统一与简化的布局**
      * **需求**: 移除工作流页面中间的“触发器”模块，将其简化为左侧“元信息”面板中的一个配置项（如一个下拉选择框）。这将为核心的“步骤编排”区域释放出大量垂直空间。
      * **命名优化**: 将“任务编排”更名为“**工作流步骤 (Workflow Steps)**”，使其更直观。
  * **FR-2.2: 数据驱动的步骤配置 UI**
      * **需求**: 在“工作流步骤”中添加一个步骤时，如果选择的是一个组件，UI 必须**根据该组件的 `component.json` 动态渲染出输入表单**。
      * **数据“打通”体验**: 对于每个输入框，旁边提供一个“连接数据”或“`{...}`”图标。点击后，弹出一个窗口，清晰地列出之前所有步骤的可用 `outputs` (例如 `{{steps.step1.output.fileUrl}}`)，供用户选择并插入。
  * **FR-2.3: 运行状态展示**
      * **需求**: 在工作流的“状态”面板中，增加几个关键的只读字段：“**上次运行状态** (成功/失败)”、“**上次运行时间**”和“**成功运行次数**”。这些数据需要在工作流执行后由后端更新。

#### Epic 3: `FeishuFS` 与容器备份深度集成 (优先级: P1)

  * **FR-3.1: 全面实现 `FeishuFS` 后端**
      * **需求**: 完成 V2.3 PRD 中定义的 `FeishuFS` 的所有后端逻辑，包括 **OAuth 认证流程** 和 **文件操作 API 封装**。
  * **FR-3.2: 激活“数据库管理”页面**
      * **需求**: 该页面不再是静态 UI。如果用户未认证，页面应只显示一个“使用飞书账号登录”的按钮。认证后，则显示为一个功能性的**虚拟文件浏览器**。
  * **FR-3.3: 激活“容器管理”页面**
      * **需求**: “容器管理”顶级导航按钮必须**永久可见**，无论其依赖是否安装。
      * **UI 实现**: 必须实现容器列表的展示和基础操作（启动、停止、日志）的 UI。
  * **FR-3.4: 场景打通：容器数据备份**
      * **需求**: 在“容器管理”页面的每个容器项上，增加一个“**配置备份**”功能。
      * **交互**: 点击后，引导用户：
        1.  选择该容器的一个或多个**数据卷挂载目录**。
        2.  设置备份周期（本质是创建一个 **Cron 触发器**）。
        3.  确认后，系统将**自动创建一个系统工作流**。该工作流包含两个步骤：一个“打包容器目录”的系统组件，和一个“上传到 Feishu Drive”的系统组件。

#### Epic 4: 系统服务的安装与 AI 功能（低优先级）

  * **FR-4.1: 容器服务的安装工作流**
      * **需求**: 将“安装容器服务”本身也做成一个官方组件或一个特殊的工作流。该脚本负责检测操作系统、下载对应的 Podman/Docker 二进制文件到项目子目录，并配置好环境。
  * **FR-4.2: LLM 辅助 Cron 表达式**
      * **需求**: 在所有需要输入 Cron 表达式的地方（触发器配置等），输入框下方增加一个带有“✨”图标的按钮“**使用 AI 生成**”。
      * **交互**: 点击后，弹出一个文本框，用户输入自然语言（如“每周一早上8点半”）。点击“生成”，后端调用预置的 LLM API（需在“设置”页面配置 Gemini/ChatGPT Key）将文本转换为 Cron 表达式并填充回输入框。**（本次迭代仅需实现 UI 和后端 API 接口，LLM 调用逻辑可暂时返回一个固定值。）**

### 5\. 任务清单 (Actionable To-Do List)

#### 后端

  - [ ] **架构**: 移除 `isolated-vm`，重构脚本执行器为 `child_process.fork()`。
  - [ ] **组件**: 实现 `component.json` 的 CRUD，并提供 API 给前端。
  - [ ] **工作流**: 更新工作流执行引擎，支持新的数据绑定 `{{...}}` 语法。
  - [ ] **工作流**: API 需记录工作流的运行历史和统计数据。
  - [ ] **FeishuFS**: 完成 OAuth 2.0 认证和 Token 管理。
  - [ ] **FeishuFS**: 实现 `FeishuFS` 模块的核心文件操作 API。
  - [ ] **容器**: 实现 `ContainerService` 的后端逻辑，能真实地调用 `podman/docker` 命令。
  - [ ] **系统服务**: 开发一个用于“安装容器服务”的系统脚本。
  - [ ] **AI**: 创建一个 `POST /api/generate-cron` 的 API 存根 (stub)。

#### 前端

  - [ ] **工作流**: 重构工作流设计器 UI，移除中央的触发器模块。
  - [ ] **工作流**: 实现基于 `component.json` 的动态步骤配置表单。
  - [ ] **工作流**: 实现数据绑定的可视化选择器 UI。
  - [ ] **组件**: 彻底重做组件编辑区，确保 `component.json` 的表单/源码双视图编辑体验。
  - [ ] **FeishuFS**: 开发“数据库管理”页面的登录和文件浏览器 UI。
  - [ ] **容器**: 开发“容器管理”页面的列表和操作 UI。
  - [ ] **容器**: 开发容器备份的配置向导 UI，实现自动创建工作流的逻辑。
  - [ ] **AI**: 开发“AI 生成 Cron”的 UI 弹窗和交互。