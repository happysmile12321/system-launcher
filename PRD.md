# Orchestrator Pro V3.0 产品需求文档（PRD）

## 版本信息
- **版本号**：V3.0
- **主题**：架构收敛与核心服务深化
- **创建日期**：2025 年 9 月 20 日

## 1. 背景与目标
经历 V2.x 的快速迭代后，平台功能丰富但架构逐渐松散：配置目录混乱、系统服务与用户组件边界模糊、核心能力缺乏深度。V3.0 的目标是“返璞归真”——统一配置体系、澄清核心概念、强化容器与备份两大系统服务，使平台达到可持续演进的生产级水准。

## 2. 核心概念澄清
- **工作流（Workflow）**：串联组件的线性步骤集合，不包含复杂逻辑，仅负责执行顺序与数据传递。
- **组件（Component）**：Node.js 脚本，负责具体功能。分官方组件（仓库提供）与用户组件（`/components` 目录）。
- **触发器（Trigger）**：启动工作流的开关，包含定时（Cron）、手动、Webhook、系统事件。
- **系统服务（System Service）**：平台内置能力，随应用常驻且不可移除，当前包括容器管理、备份管理。
- **容器化服务（Containerized Service）**：由容器管理系统服务托管的第三方应用，例如知识库、数据库等。

## 3. 仓库信息架构要求
为杜绝配置混乱，`.orchestrator-pro/` 目录必须遵循下列结构（原 `config/` 废弃）：
```
.orchestrator-pro/
├── workflows/         # 工作流定义（*.workflow.json）
├── components/        # 用户组件目录
├── triggers/          # 触发器配置
├── containers/        # 容器管理相关配置（含 compositions/ 等）
├── feishu/            # 飞书应用配置
├── system_services/   # 系统服务配置
├── backups/           # 【忽略提交】本地备份产物
└── recovery/          # 【忽略提交】恢复临时文件
```
`.gitignore` 中必须排除 `backups/`、`recovery/`。

## 4. 功能需求

### 4.1 Epic：配置与架构重构（P0）
1. **GitFS 重构**：重写 `src/core/gitfs.js` 读写逻辑以适配新目录结构，并支持旧数据迁移。
2. **界面术语统一**：
   - 导航“设置”重命名为“系统服务”。
   - 导航“数据库管理”重命名为“备份管理”。
3. **系统服务配置流**：
   - 取消“安装/卸载”概念，服务默认存在。
   - “系统服务”页面展示容器管理、备份管理卡片，配置表单保存至 `.orchestrator-pro/system_services/`。

### 4.2 Epic：容器管理对标 Docker Desktop（P0）
1. **官方组件执行**：所有 Docker 操作（`ps/start/stop/compose` 等）统一通过官方组件实现，禁止直接调用 Docker API。
2. **页面结构**：容器管理页面包含“容器”“镜像”“容器组”三个子标签：
   - 列表展示容器，提供启动、停止、删除、日志查看。
   - 支持上传/编辑 `docker-compose.yml`，提供表格化编辑器与部署、停止、验证动作。
3. **系统事件触发器**：容器启动/停止事件写入触发器系统，支持构建告警工作流。

### 4.3 Epic：备份管理（原数据库管理）（P0）
1. **FeishuFS 完备**：实现飞书 OAuth2、文件读写、搜索、上传、删除等全部逻辑。
2. **备份计划向导**：
   - 向导流程包含“选择备份源→选择容器→配置 Cron→确认”。
   - 成功后自动创建 Cron 触发的工作流，依次执行“容器数据打包”“上传飞书云盘”。

### 4.4 Epic：组件管理精炼（P1）
- 在组件管理页面增加“是否公开”开关：公开组件自动从 `.gitignore` 中移除，便于提交到仓库；私有组件保持忽略。

## 5. 任务拆解

### 5.1 后端任务
- [ ] 重构 GitFS 适配新 IA。
- [ ] 移除系统服务安装/卸载逻辑。
- [ ] 提供面向容器操作的官方组件（`list-containers`、`start-container`、`stop-container`、`exec-compose` 等）。
- [ ] 实现容器系统事件触发器桥接。
- [ ] 完成 Feishu OAuth 与文件操作 API。
- [ ] 实现备份计划生成与工作流自动创建。
- [ ] 动态维护 `.gitignore`，支持组件公开/私有切换。

### 5.2 前端任务
- [ ] 更新所有与 GitFS 交互的页面，适配新目录结构。
- [ ] 重建“系统服务”页面配置流程。
- [ ] 完成容器管理三大子页面及 Compose 表格编辑器。
- [ ] 打通备份计划向导 UI 与 API。
- [ ] 在组件管理界面新增“公开”开关与状态展示。

## 6. 验收标准
- 新目录结构可在真实 GitHub 仓库中创建并读取，无残留旧路径。
- 容器管理界面对齐 Docker Desktop 常用操作，所有按钮均调用官方组件，返回结果一致。
- 备份计划创建后，能在工作流列表中看到自动生成的 Cron 工作流，并成功执行容器数据备份→飞书上传链路。
- 组件公开/私有切换后 `.gitignore` 状态即时生效，并在组件列表中正确展示。

## 7. 风险与缓解
- **风险**：GitFS 重构涉及历史数据；**缓解**：提供迁移脚本并在测试环境验证。
- **风险**：Docker 操作依赖外部环境；**缓解**：开发/测试阶段提供模拟数据或环境检查。
- **风险**：飞书权限审核耗时；**缓解**：提前准备权限申请说明并参考《飞书权限配置说明》。

## 8. 交付要求
- 代码通过现有 lint/格式化检查。
- 所有关联文档（用户指南、开发总结、版本纪要）同步更新。
- 对外发布前完成手动验证：`npm run cli`、`npm start`、容器管理核心功能、备份计划完整链路。

---

本 PRD 作为 V3.0 迭代的执行依据，后续如需变更请在评审后更新对应章节并注明日期。
