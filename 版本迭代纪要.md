# Orchestrator Pro 历史版本迭代纪要

## V2.3：核心功能修复与深度集成（2024.01.27 - 2024.02.16）

### 目标与计划（节选）
- **总体目标**：从“看起来能用”升级为“用起来可靠”，重构组件编辑体验、完善触发器体系、补齐飞书集成。
- **关键 Epic**：
  1. 组件工作区补全（Monaco 编辑器、组件清单表单、执行测试修复）。
  2. 触发器系统增强（Cron 表达式、Webhook 异步队列）。
  3. 系统服务集成（飞书 OAuth、FeishuFS、容器服务优化）。
  4. UI/UX 优化（骨架屏、防抖、加载反馈）。
- **风险提示**：Feishu OAuth 与异步队列为高风险项，Monaco 集成和 ES Module 兼容属中风险。

### 核心成果
- **组件系统**：
  - `MonacoEditor.vue` 提供语法高亮、自动补全、错误提示。
  - `ComponentManager.vue` 支持表单视图/源码视图切换，输入输出 Schema 驱动表单。
  - `componentService.js` 引入 `isolated-vm` 沙箱并修复 ES Module 兼容（后续版本再演进）。
- **触发器体系**：
  - `triggerService.js` 实现 Cron 触发，`/api/triggers/cron/*` 对外服务。
  - `taskQueueService.js` 构建异步任务队列，Webhook 请求快速返回 202，后台异步处理。
- **飞书生态**：
  - `feishuOAuthService.js` 完整实现 OAuth2 授权与 Token 刷新。
  - `feishuFS.js` 支持文件上传、下载、搜索、权限控制。
- **UI/UX**：引入骨架屏、按钮防抖、自定义加载提示，整体交互流畅度显著提升。

### 已解决问题（摘自《V2.3 问题修复总结》）
1. **Monaco 编辑器无限滚动**：限制滚动条、容器宽度，结构更加稳定。
2. **系统组件误编辑**：官方组件在表单视图中统一只读，并给出提示。
3. **组件执行 const 语法报错**：修复 `isolated-vm` 模块加载与关键字兼容。
4. **触发器列表缺失**：Trigger 管理器同时拉取 Cron / Webhook，统一展示。
5. **定时触发器入口缺失**：新增创建按钮与配置弹窗。
6. **数据库管理入口缺失**：导航增加“数据库管理”，实现飞书文件浏览、备份计划视图。
7. **飞书预览与备份计划**：完善文件列表、下载、删除与计划展示逻辑。

### 结论
- P0 任务全部完成，Cron/Webhook/组件编辑体验达到可用标准。
- 制定了后续容器服务优化与性能监控方向，为 V2.4 升级铺平道路。

---

## V2.4：架构简化与体验重构（2024.03 - 2024.04）

### 核心改动
1. **组件执行模型革命**：
   - 抛弃 `isolated-vm`，改用 `child_process.fork()` 标准 Node 运行环境。
   - 临时脚本落盘执行，约定 30 秒超时，IPC 传递执行结果。
2. **组件目录统一**：移除 `official/user` 分层，所有组件收敛到 `/components`，并通过 `type` 区分。
3. **组件 Schema 强化**：`component.json` 强制声明输入/输出类型、必填项、默认值，前端据此自动渲染表单。
4. **工作流设计器 UX 重构**：
   - 触发器配置移至左侧信息面板，步骤区域改为双列布局。
   - 动态表单与数据绑定提示全面上线。
5. **FeishuFS 与备份能力**：补齐 OAuth、文件管理、搜索、上传下载、服务可用性巡检。
6. **容器管理界面激活**：列表、启动、停止、日志、Compose 管理一应俱全，支持 Docker/Podman 双驱动。
7. **AI Cron 辅助**：中文描述自动生成 Cron 表达式，并提供常用模板建议。

### 用户体验收益
- 工作流设计区域更大，配置流程更顺滑。
- 容器页面具备 Docker Desktop 级别功能，可直接生成备份工作流。
- Cron 生成更智能，降低排班门槛。

### 质量与性能
- 进程隔离执行组件杜绝了内存泄露与语法兼容问题。
- 前端按需加载、状态管理细化，操作反馈更即时。
- 安全方面新增超时保护、目录限制、操作提示。

---

## V3.0：架构收敛与核心服务 Mastery（2025.01）

### 架构升级
1. **GitFS 重构**：
   - `.orchestrator-pro/` 目录结构标准化：`workflows/`、`components/`、`triggers/`、`containers/`、`feishu/`、`system_services/`、`backups/`、`recovery/`。
   - 兼容旧数据并提供自动迁移逻辑。
2. **导航与概念统一**：前端导航改为“系统服务”“备份管理”等与 PRD 一致的术语。
3. **系统服务重构**：默认随平台存在，只提供配置入口，不再暴露安装/卸载动作。

### 核心能力深化
1. **容器管理革命**：
   - 所有容器操作统一调用官方组件（`list-containers`、`start-container`、`stop-container`、`exec-compose`）。
   - `containerService.js` 引入进程隔离、超时、数据解析一致化。
   - 修复容器列表空白、镜像大小显示 `NaN`、数据映射不一致等历史问题。
2. **Compose 管理完善**：
   - `CompositionsTab.vue` 全新界面：列表总览、双模式（YAML + 可视化）编辑、Monaco 支持、部署/验证/停止等操作按钮。
   - 后端 `routes/compositions.js` 提供 CRUD、校验、部署 API，全流程闭环。
3. **备份管理**：
   - `backupManagementService.js` 打通容器→备份→飞书上传链路，支持生成定时工作流、查看状态。
   - `backupManagement` 路由覆盖状态查询、容器列表、工作流 CRUD。
4. **组件可见性管理**：
   - 组件服务新增公有/私有开关，自动维护 `.gitignore`。
   - API 暴露可见性读取与设置端点。
5. **UI 优化延续**：
   - `UI_ENHANCEMENT` 中的组件管理双栏、备份管理 WebSocket 状态提示、README 全面重写等全部纳入正式版本。

### 问题修复归档
- **Docker 容器数据为空**：改为解析 CLI `--format json` 输出，并补齐字段映射。
- **镜像大小 NaN**：前端 `formatSize` 兼容服务器返回的已格式化字符串。
- **早期文档零散**：所有规范、路线图、部署说明集中到了新的《项目总览与规范》和《版本迭代纪要》。

### PRD 约束落实
- 明确工作流、组件、触发器、系统服务、容器服务之间的边界。
- GitHub 仓库 `.orchestrator-pro/` 目录执行强制布局，废除旧 `config/`。
- 系统服务页面聚焦配置而非安装。

---

## 维护指引
- 如需追加新版本，请在相应章节下补充“目标/成果/问题修复/用户收益/风险”等小节，保持结构一致。
- 若涉及跨版本复用的特性，请在正文引用对应模块文件，避免重复撰写。
- 所有内容请保持中文表述，必要的技术名词可保留英文原名（Node.js、Docker 等）。

---

> 本纪要整合了旧版《V2.3开发计划》《V2.3技术总结》《V2.3问题修复总结》《V2.4开发总结》《V3.0开发总结》以及“容器组管理”“Docker 修复”“镜像大小修复”“UI 完善”等专题文档，供团队快速回顾历史迭代。后续如需新增专题，可在末尾追加“补充专题”小节。
