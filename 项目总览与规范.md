# Orchestrator Pro 项目总览与规范

## 一、项目定位
- **目标**：提供面向 DevOps 团队的智能编排平台，统一容器管理、备份、触发器和组件生态。
- **核心卖点**：可视化工作流、组件化执行引擎、GitHub 驱动配置、飞书企业协同、Docker/Podman 双驱动支持。
- **运行环境**：Node.js 18+、npm、Docker（可选）、GitHub 仓库授权、飞书开放平台凭证（可选）。

## 二、系统架构速览
- **CLI (`src/cli/index.js`)**：提供编排状态查看、Docker 自动化部署、系统服务初始化、Cloudflare 网关配置等操作。
- **核心模块 (`src/core/`)**：
  - `gitfs.js`：封装 GitHub API，统一 `.orchestrator-pro/` 命名空间的读写。
  - `orchestration.js`：加载/保存编排状态。
  - `deployment.js`：预留 Docker 与 Cloudflare 部署流程。
- **服务层 (`src/services/`)**：
  - `configService.js`：加载 `.orchestrator.config.json`，校验 GitHub Token 与飞书配置。
  - `githubService.js`：通过 GitFS 同步编排配置。
  - `containerService.js`：容器生命周期管理，默认调用 `components/container-management/*` 官方组件。
  - `backupManagementService.js`、`containerBackupService.js`：容器备份与飞书云盘接入。
  - `workflowService.js`：工作流 CRUD，存储于 `.orchestrator-pro/workflows`。
  - `schedulerService.js`：基于 `node-schedule` 的定时同步任务。
  - 其他服务涵盖 AI Cron、Feishu OAuth/WebSocket、Trigger、Task Queue 等功能。
- **Web 端 (`src/web/`)**：
  - `server.js`：Express 主应用，负责初始化配置校验、静态资源托管、REST 路由注册、调度器启动。
  - `routes/`：包含容器、组件、触发器、备份、AI Cron、Feishu 等 API。
  - `ui/`：Vue 3 + Vite 前端工程，组件化实现工作流设计器、容器/镜像页面、备份管理中心等界面。
- **官方组件 (`components/`)**：
  - `container-management/`：列出、启动、停止容器，执行 Compose。
  - `container-backup/`：结合备份服务输出压缩包。
  - `feishu-rich-text-report/`、`github-file-backup/`：面向飞书汇报与 GitHub 备份的脚本。

## 三、开发运行指南
- **安装依赖**：`npm install`
- **本地前端构建**：`npm run web:dev`（开发调试）或 `npm run web:build`
- **启动后端**：`npm start`，默认监听 `http://localhost:3000`
- **CLI 入口**：`npm run cli`
- **Docker 运行**：使用根目录 `docker-compose.yml` 或 `Dockerfile`
- **CI/CD**：GitHub Actions 工作流位于 `.github/workflows/ci.yml`

> 当前 `npm test` 仅为占位，请在引入自动化测试前替换为实际测试命令。

## 四、编码规范与命名约定
- **模块化**：项目启用原生 ES Modules，所有文件使用 `import/export`。
- **缩进与格式**：两空格缩进、保留分号；变量/函数使用小驼峰、类使用大驼峰。
- **日志**：统一走 `src/utils/logger.js` 的 `info/success/warning/error` 接口，确保 CLI/UI 输出风格一致。
- **文件限制**：前端 `.vue/.js/.ts` 单文件不超过约 500 行，复杂逻辑拆分为子组件或 `hooks`，通用工具放入 `utils`。
- **组件设计**：
  - 原子组件 → 业务组件 → 页面组件 三层结构。
  - 通过 Props 和事件传递数据，保持高内聚低耦合。
  - 业务状态/逻辑建议封装为 `useXxx` 自定义 Hook。
- **注释要求**：关键逻辑、复杂算法、重要 Props/事件需提供简洁注释，必要时提供中英对照摘要。

## 五、测试与质量保障
- **目录约定**：在 `tests/` 下镜像 `src/` 结构，例如 `tests/core/scriptRunner.test.js`。
- **测试范围**：
  - GitFS 操作需通过桩/Mock 避免真实写仓库。
  - Scheduler、Trigger、CLI、Express 路由需覆盖核心路径。
  - 重点验证编排持久化、容器备份链路、飞书集成。
- **准入标准**：所有失败测试必须阻止合并；在提交 PR 前至少运行一次 CLI 与 Web 核心流程手动验证。

## 六、配置与安全注意事项
- **敏感信息**：GitHub Token、飞书凭证统一放入 `.env` 或 `.orchestrator.config.json`，严禁写死在代码中。
- **GitFS 写入**：提交前确认 `.orchestrator-pro/backups`、`.orchestrator-pro/recovery` 等敏感目录处于 `.gitignore` 状态。
- **系统服务部署**：CLI 的系统服务部署需要本地存在 `docker-compose.yml`，并要求 Docker、docker-compose 已安装。
- **Cloudflare 网关**：若使用 `wrangler`，需提前登录并配置 `cloudflare/wrangler.toml`。

## 七、合作流程与提交规范
- **提交信息**：使用 `<type>: <summary>`，动词使用祈使句，可根据需要追加中文补充说明。
- **分支策略**：保持一次迭代一个特性分支，提交与 PR 范围保持单一职责。
- **PR 内容**：必须说明场景、列出手动验证命令（`npm run cli`、`npm start`），若涉及 UI 需附截图或录屏。
- **敏感文件检查**：提交前确认 `.orchestrator.config.json` 没有被纳入版本控制。

## 八、重要子系统速查
- **工作流设计器**：支持拖拽、步骤参数动态表单、触发器配置整合在左侧面板，支持 `{{steps.xxx.outputs.yyy}}` 数据绑定。
- **容器管理**：容器列表、镜像列表、Compose 管理三大板块；所有操作通过官方组件执行并带 30 秒超时保护。
- **备份管理**：集成飞书云盘，可扫描容器、生成定时备份工作流、查看备份记录，与 GitFS/FeishuFS 紧密衔接。
- **AI Cron 助手**：`src/services/aiCronService.js` 提供中文自然语言到 Cron 的解析能力，配合前端表单快速生成定时任务。
- **Feishu 集成**：OAuth、长连接 WebSocket、云盘 API 均已封装；详见《飞书权限配置说明.md》。

## 九、文档维护建议
- 新增或修改根目录文档时，务必同步更新本文件相关段落。
- 若引入新的版本迭代，请在《版本迭代纪要.md》中追加对应章节。
- 涉及飞书权限、前端规范等专题内容，可在原有文件上更新并注明版本时间。

---

> 本文件旨在取代旧版 `README.md`、`PROJECT_SUMMARY.md`、`AGENTS.md` 等英文资料，集中呈现项目概况与协作规范，后续更新请保持中文语境一致。
