# 飞书集成配置说明

## 1. 在飞书开放平台创建应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 登录并创建新应用
3. 在应用设置中获取以下信息：
   - App ID
   - App Secret

## 2. 配置应用权限

在飞书开放平台的应用权限管理中，添加以下权限：
- `user:read` - 获取用户基本信息
- `drive:read` - 读取云盘文件
- `drive:write` - 写入云盘文件

## 3. 配置重定向URI

在飞书开放平台的安全设置中，配置重定向URI：
```
http://localhost:3000/api/feishu/auth/callback
```

## 4. 设置环境变量

创建 `.env` 文件并添加以下配置：

```bash
# 飞书开放平台配置
FEISHU_APP_ID=your_app_id_here
FEISHU_APP_SECRET=your_app_secret_here
FEISHU_REDIRECT_URI=http://localhost:3000/api/feishu/auth/callback

# GitHub配置
GITHUB_TOKEN=your_github_token_here
GITHUB_REPO=your_username/your_repo_name

# 其他配置
NODE_ENV=development
PORT=3000
```

## 5. 前端与服务端配合流程

### 前端流程：
1. 用户点击"连接飞书账号"按钮
2. 前端调用 `/api/feishu/auth/start` 获取授权URL
3. 打开新窗口跳转到飞书授权页面
4. 用户完成授权后，飞书重定向到回调地址
5. 前端监听窗口关闭事件，自动刷新认证状态

### 服务端流程：
1. 接收前端请求，生成授权URL
2. 处理飞书回调，交换授权码获取访问令牌
3. 获取用户信息
4. 将认证状态保存到GitFS
5. 返回认证结果页面

## 6. 认证状态持久化

认证状态会保存到GitFS的 `.orchestrator-pro/feishu-auth.json` 文件中，包含：
- 访问令牌
- 刷新令牌
- 用户信息
- 认证时间

## 7. 注意事项

- 确保重定向URI与飞书开放平台配置一致
- 使用HTTPS进行生产环境部署
- 定期检查令牌过期时间
- 妥善保管App Secret，不要提交到代码仓库

## 8. 故障排除

### 常见错误：
1. `Feishu App ID not configured` - 检查环境变量配置
2. `Token exchange failed` - 检查App Secret是否正确
3. `Authorization code is required` - 检查重定向URI配置

### 调试步骤：
1. 检查环境变量是否正确设置
2. 验证飞书开放平台应用配置
3. 查看服务器日志获取详细错误信息
4. 确认网络连接正常
